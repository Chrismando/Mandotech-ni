<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>MANDO'TECH - G√©n√©rateur de Factures</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- BOOTSTRAP -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- jsPDF + html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- Three.js pour l'animation 3D -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<style>
/* -------------------------------------
   üåü ANIMATION INTRO MANDO'TECH 3D
--------------------------------------*/
#splash {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #000428, #004e92);
  color: white;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  overflow: hidden;
  font-family: 'Arial', sans-serif;
  opacity: 1;
  visibility: visible;
  transition: opacity 1s ease, visibility 1s ease;
}

#splash.fade-out {
  opacity: 0;
  visibility: hidden;
}

#splash-content {
  position: relative;
  z-index: 10;
  text-align: center;
}

#splash h1 {
  font-size: 4rem;
  font-weight: 900;
  letter-spacing: 8px;
  margin-bottom: 1rem;
  text-transform: uppercase;
  background: linear-gradient(45deg, #00adee, #00ff88, #ff0080, #00adee);
  background-size: 400% 400%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: gradientShift 3s ease infinite, glowPulse 2s ease-in-out infinite alternate;
}

#threeCanvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 1;
}

@keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

@keyframes glowPulse {
  from { 
    filter: drop-shadow(0 0 10px #00adee);
    transform: scale(1);
  }
  to { 
    filter: drop-shadow(0 0 30px #00ff88);
    transform: scale(1.05);
  }
}

/* -------------------------------------
   üé® DESIGN GLOBAL
--------------------------------------*/
body {
  background: #f5f7fa;
  font-family: 'Segoe UI', sans-serif;
}

.card {
  border-radius: 12px;
  border: none;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.badge-mando {
  background: #00adee;
}

.btn-mando {
  background:#00adee;
  color:white;
  border:none;
}

.btn-mando:hover {
  background:#0086b3;
}

.btn-whatsapp {
  background: #25D366;
  color: white;
}

.btn-whatsapp:hover {
  background: #128C7E;
  color: white;
}

.btn-email {
  background: #EA4335;
  color: white;
}

.btn-email:hover {
  background: #D14836;
  color: white;
}

/* -------------------------------------
   ‚úçÔ∏è CANVAS SIGNATURE
--------------------------------------*/
#signaturePad {
  border: 2px dashed #00adee;
  width: 100%;
  height: 150px;
  cursor: crosshair;
  border-radius: 8px;
  background-color: #f8f9fa;
  touch-action: none;
}

/* -------------------------------------
   üñº LOGO APER√áU
--------------------------------------*/
#logoPreview {
  max-width: 120px;
  max-height: 120px;
  object-fit: contain;
  display: none;
}

/* TABLEAU FACTURE */
table input {
  width: 100%;
  border: 1px solid #dee2e6;
  padding: 0.375rem 0.75rem;
  border-radius: 0.25rem;
}

.watermark {
  position:absolute;
  inset:0;
  opacity:0.06;
  font-size:100px;
  transform: rotate(-30deg);
  text-align:center;
  top:30%;
  pointer-events:none;
  font-weight: bold;
  color: #00adee;
}

/* Am√©lioration responsive */
@media (max-width: 992px) {
  .watermark {
    font-size: 60px;
  }
  #splash h1 {
    font-size: 2.5rem;
    letter-spacing: 4px;
  }
}

/* Am√©lioration visuelle des champs */
.form-control:focus {
  border-color: #00adee;
  box-shadow: 0 0 0 0.2rem rgba(0, 173, 238, 0.25);
}

/* Style pour les montants */
.amount {
  font-weight: bold;
  color: #2c3e50;
}

/* Modal pour afficher le PDF */
.modal-content {
  border-radius: 12px;
}

.pdf-preview {
  width: 100%;
  height: 600px;
  border: none;
}

.pdf-placeholder {
  text-align: center;
  padding: 2rem;
  color: #6c757d;
}

.pdf-placeholder i {
  font-size: 3rem;
  margin-bottom: 1rem;
  display: block;
}

/* Style sp√©cifique pour l'aper√ßu PDF */
#invoicePreview {
  background: white;
  position: relative;
  min-height: 800px;
  padding: 30px;
  width: 210mm; /* Largeur A4 */
  margin: 0 auto;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

#invoicePreview .table {
  margin-bottom: 1rem;
  font-size: 14px;
}

#invoicePreview .text-end {
  margin-top: 2rem;
  padding-top: 1rem;
  border-top: 2px solid #dee2e6;
}

/* Boutons de partage */
.share-buttons {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 10px;
}

/* Am√©lioration du tableau des articles */
#itemsTable input {
  border: 1px solid #ced4da;
  border-radius: 4px;
  padding: 6px 8px;
  font-size: 14px;
}

#itemsTable input:focus {
  border-color: #00adee;
  outline: none;
  box-shadow: 0 0 0 2px rgba(0, 173, 238, 0.25);
}

/* Signature dans l'aper√ßu */
#p_signature {
  border: 1px solid #dee2e6;
  border-radius: 4px;
  background: white;
  max-width: 200px;
}

/* Optimisation pour PDF */
.pdf-optimized {
  font-size: 14px !important;
  line-height: 1.4 !important;
}

.pdf-optimized h3 {
  font-size: 18px !important;
}

.pdf-optimized h4 {
  font-size: 16px !important;
}

.pdf-optimized h5 {
  font-size: 14px !important;
}

/* Am√©lioration de l'affichage PDF */
#pdfPreviewContainer {
  height: 600px;
  overflow: auto;
  border: 1px solid #dee2e6;
  border-radius: 8px;
}

.pdf-viewer {
  width: 100%;
  height: 100%;
  border: none;
}

.pdf-iframe {
  width: 100%;
  height: 100%;
  border: none;
}

/* Informations entreprise en gras */
.entreprise-bold {
  font-weight: bold !important;
}

.entreprise-bold h3 {
  font-weight: bold !important;
}

/* Boutons d'action PDF */
.pdf-actions {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1000;
  display: flex;
  gap: 10px;
}

.pdf-actions .btn {
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

/* Page PDF partage */
#pdfSharePage {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: white;
  z-index: 9998;
  padding: 20px;
  overflow-y: auto;
}

#pdfSharePage .container {
  max-width: 800px;
  margin: 0 auto;
}

#pdfSharePage .share-header {
  text-align: center;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 2px solid #00adee;
}

#pdfSharePage .share-options {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.share-option-card {
  border: 1px solid #dee2e6;
  border-radius: 10px;
  padding: 20px;
  text-align: center;
  transition: all 0.3s ease;
  cursor: pointer;
}

.share-option-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  border-color: #00adee;
}

.share-option-card i {
  font-size: 2.5rem;
  margin-bottom: 10px;
  display: block;
}

.share-option-card.whatsapp {
  background: linear-gradient(135deg, #25D366, #128C7E);
  color: white;
}

.share-option-card.email {
  background: linear-gradient(135deg, #EA4335, #D14836);
  color: white;
}

.share-option-card.download {
  background: linear-gradient(135deg, #00adee, #0086b3);
  color: white;
}

.share-option-card.print {
  background: linear-gradient(135deg, #6c757d, #495057);
  color: white;
}
</style>
</head>

<body>

<!-- üü¶ SPLASH SCREEN 3D -->
<div id="splash">
  <canvas id="threeCanvas"></canvas>
  <div id="splash-content">
    <h1>MANDO'TECH</h1>
  </div>
</div>

<!-- üü¶ CONTENU PRINCIPAL -->
<div class="container py-4" style="display: none;" id="mainContent">

  <h2 class="mb-3 text-center">
    G√©n√©rateur de Factures ‚Äì <span class="badge bg-primary">MANDO'TECH</span>
  </h2>

  <div class="row">
    <!-- üüß FORMULAIRE FACTURE -->
    <div class="col-lg-5">
      <div class="card p-3 mb-3">
        <h4 class="text-primary">Informations Entreprise</h4>

        <label class="mt-2">Logo :</label>
        <input type="file" id="logoUpload" accept="image/*" class="form-control mb-2">
        <img id="logoPreview" class="mb-3">

        <input id="entName" class="form-control mb-2" placeholder="Nom entreprise">
        <input id="entAddress" class="form-control mb-2" placeholder="Adresse compl√®te">
        <input id="entSiret" class="form-control mb-2" placeholder="SIRET">
        <input id="entTVA" class="form-control mb-2" placeholder="Num√©ro TVA">
        <input id="entContact" class="form-control mb-2" placeholder="Email / T√©l√©phone">

      </div>

      <div class="card p-3 mb-3">
        <h4 class="text-success">Informations Client</h4>
        <input id="clientName" class="form-control mb-2" placeholder="Nom complet client">
        <input id="clientAddress" class="form-control mb-2" placeholder="Adresse client">
        <input id="clientEmail" class="form-control mb-2" placeholder="Email client" type="email">
        <input id="clientPhone" class="form-control mb-2" placeholder="T√©l√©phone client">
      </div>

      <div class="card p-3 mb-3">
        <h4 class="text-warning">Param√®tres Facture</h4>

        <label>Date d'√©mission :</label>
        <input id="dateEmis" type="date" class="form-control mb-2">

        <label>Date d'√©ch√©ance :</label>
        <input id="dateDue" type="date" class="form-control mb-2">

        <label>Num√©ro de facture :</label>
        <input id="invoiceNumber" class="form-control mb-2" placeholder="Ex : MT-2025-001">

        <label>TVA (%) :</label>
        <input id="tvaValue" type="number" value="20" class="form-control mb-2">

        <label>Devise :</label>
        <select id="currency" class="form-control mb-2">
          <option value="‚Ç¨">Euro (‚Ç¨)</option>
          <option value="$">Dollar ($)</option>
          <option value="¬£">Livre (¬£)</option>
          <option value="FCFA">Franc CFA (F CFA)</option>
          <option value="CDF">Franc Congolais (CDF)</option>
        </select>

      </div>

      <div class="card p-3 mb-3">
        <h4 class="text-danger">Signature Num√©rique</h4>
        <canvas id="signaturePad" width="400" height="150"></canvas>
        <div class="mt-2">
          <button type="button" class="btn btn-sm btn-secondary" id="clearSign">Effacer</button>
          <button type="button" class="btn btn-sm btn-primary" id="saveSign">Sauvegarder</button>
        </div>
      </div>

      <div class="card p-3 mb-4">
        <h4 class="text-dark">Notes / Conditions</h4>
        <textarea id="notes" rows="4" class="form-control" placeholder="Conditions de paiement, mentions l√©gales..."></textarea>
      </div>

    </div>

    <!-- üü© APER√áU FACTURE OPTIMIS√â POUR PDF -->
    <div class="col-lg-7">
      <div class="card p-4 pdf-optimized" id="invoicePreview">
        
        <div class="watermark">MANDO'TECH</div>

        <div class="d-flex justify-content-between align-items-start mb-4 entreprise-bold">
          <div>
            <h3 id="p_entName">Nom de l'entreprise</h3>
            <p id="p_entAddress">Adresse de l'entreprise</p>
            <p id="p_entSiret">SIRET : </p>
            <p id="p_entTVA">TVA : </p>
            <p id="p_entContact">Contact</p>
          </div>
          <img id="p_logo" style="max-width:120px; max-height:120px; display:none;">
        </div>

        <hr>

        <div class="row mb-4">
          <div class="col-md-6">
            <h4>Facture : <span id="p_invoiceNumber">N¬∞</span></h4>
            <p>Date d'√©mission : <span id="p_dateEmis">-</span></p>
            <p>Date d'√©ch√©ance : <span id="p_dateDue">-</span></p>
          </div>
        </div>

        <div class="mb-4">
          <h4>Client :</h4>
          <p id="p_clientName">Nom du client</p>
          <p id="p_clientAddress">Adresse du client</p>
          <p id="p_clientEmail">Email : </p>
          <p id="p_clientPhone">T√©l√©phone : </p>
        </div>

        <div class="mb-4">
          <h4>Articles / Services</h4>
          <table class="table table-bordered" id="itemsTable">
            <thead>
              <tr>
                <th>Description</th>
                <th width="80">Qt√©</th>
                <th width="120">Prix unitaire</th>
                <th width="120">Total</th>
                <th width="50"></th>
              </tr>
            </thead>
            <tbody id="itemsBody">
              <!-- Les articles seront ajout√©s ici dynamiquement -->
            </tbody>
          </table>

          <button type="button" class="btn btn-primary btn-sm mb-3" id="addItem">+ Ajouter un article</button>
        </div>

        <div class="text-end mt-4">
          <p>Sous-total : <strong id="p_sousTotal" class="amount">‚Ç¨0.00</strong></p>
          <p>TVA : <strong id="p_TVA" class="amount">‚Ç¨0.00</strong></p>
          <h4>Total TTC : <strong id="p_totalTTC" class="amount">‚Ç¨0.00</strong></h4>
        </div>

        <div class="row mt-4">
          <div class="col-md-6">
            <h5>Signature</h5>
            <img id="p_signature" style="max-width:200px; max-height:100px; display:none;">
          </div>
        </div>

        <div class="mt-4">
          <h5>Notes</h5>
          <p id="p_notes">Aucune note</p>
        </div>

      </div>

      <div class="mt-3">
        <button type="button" class="btn btn-success mb-2" id="btnPDF">üìÑ G√©n√©rer PDF</button>
        <button type="button" class="btn btn-info mb-2" id="btnPreviewPDF">üëÅÔ∏è Voir Aper√ßu</button>
        <button type="button" class="btn btn-whatsapp mb-2" id="btnWhatsAppDirect">üì± Partager sur WhatsApp</button>
        <button type="button" class="btn btn-secondary mb-2" id="btnNew">üîÑ Nouvelle facture</button>
      </div>

    </div>
  </div>
</div>

<!-- Modal pour afficher l'aper√ßu PDF -->
<div class="modal fade" id="pdfModal" tabindex="-1" aria-labelledby="pdfModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pdfModalLabel">Aper√ßu de la Facture - MANDO'TECH</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="pdfPreviewContainer">
          <div class="pdf-placeholder">
            <i>üìÑ</i>
            <p>G√©n√©ration de l'aper√ßu en cours...</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        <button type="button" class="btn btn-whatsapp" id="shareWhatsAppFromPreview">Partager sur WhatsApp</button>
        <button type="button" class="btn btn-primary" id="btnOpenSharePage">üì§ Options de Partage</button>
      </div>
    </div>
  </div>
</div>

<!-- Page de partage PDF -->
<div id="pdfSharePage">
  <div class="container">
    <div class="share-header">
      <h2>Partager votre Facture</h2>
      <p class="text-muted">Choisissez comment vous souhaitez partager votre facture</p>
    </div>

    <div class="share-options">
      <div class="share-option-card whatsapp" id="shareWhatsAppCard">
        <i>üì±</i>
        <h5>WhatsApp</h5>
        <p>Partager via WhatsApp</p>
      </div>

      <div class="share-option-card email" id="shareEmailCard">
        <i>üìß</i>
        <h5>Email</h5>
        <p>Envoyer par email</p>
      </div>

      <div class="share-option-card download" id="downloadPDFCard">
        <i>üíæ</i>
        <h5>T√©l√©charger</h5>
        <p>Sauvegarder sur l'appareil</p>
      </div>

      <div class="share-option-card print" id="printPDFCard">
        <i>üñ®Ô∏è</i>
        <h5>Imprimer</h5>
        <p>Imprimer la facture</p>
      </div>
    </div>

    <div class="text-center">
      <button type="button" class="btn btn-secondary btn-lg" id="btnBackToInvoice">
        ‚Üê Retour √† la facture
      </button>
    </div>
  </div>
</div>

<!-- Boutons d'action PDF (affich√©s pendant l'aper√ßu) -->
<div class="pdf-actions" id="pdfActions" style="display: none;">
  <button type="button" class="btn btn-whatsapp" id="btnWhatsAppFloating">
    üì± WhatsApp
  </button>
  <button type="button" class="btn btn-primary" id="btnShareFloating">
    üì§ Partager
  </button>
  <button type="button" class="btn btn-secondary" id="btnBackFloating">
    ‚Üê Retour
  </button>
</div>

<script>
// ==================== ANIMATION 3D ====================
function initThreeJS() {
  try {
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    
    const canvas = document.getElementById('threeCanvas');
    const renderer = new THREE.WebGLRenderer({ 
      canvas: canvas,
      alpha: true,
      antialias: true
    });
    
    renderer.setSize(window.innerWidth, window.innerHeight);
    
    const ambientLight = new THREE.AmbientLight(0x404040, 2);
    scene.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0x00adee, 1);
    directionalLight.position.set(1, 1, 1);
    scene.add(directionalLight);

    const particlesCount = 800;
    const positions = new Float32Array(particlesCount * 3);
    const colors = new Float32Array(particlesCount * 3);
    
    for(let i = 0; i < particlesCount * 3; i += 3) {
      positions[i] = (Math.random() - 0.5) * 20;
      positions[i + 1] = (Math.random() - 0.5) * 20;
      positions[i + 2] = (Math.random() - 0.5) * 20;
      
      colors[i] = Math.random() * 0.5 + 0.5;
      colors[i + 1] = Math.random() * 0.8 + 0.2;
      colors[i + 2] = Math.random() * 0.5 + 0.5;
    }
    
    const particlesGeometry = new THREE.BufferGeometry();
    particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    particlesGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
    
    const particlesMaterial = new THREE.PointsMaterial({
      size: 0.1,
      vertexColors: true,
      transparent: true,
      opacity: 0.8
    });
    
    const particles = new THREE.Points(particlesGeometry, particlesMaterial);
    scene.add(particles);
    
    const torusGeometry = new THREE.TorusGeometry(3, 0.8, 16, 100);
    const torusMaterial = new THREE.MeshBasicMaterial({ 
      color: 0x00ff88, 
      wireframe: true,
      transparent: true,
      opacity: 0.8
    });
    const torus = new THREE.Mesh(torusGeometry, torusMaterial);
    scene.add(torus);
    
    const torus2Geometry = new THREE.TorusGeometry(2, 0.4, 12, 80);
    const torus2Material = new THREE.MeshBasicMaterial({ 
      color: 0x00adee, 
      wireframe: true,
      transparent: true,
      opacity: 0.6
    });
    const torus2 = new THREE.Mesh(torus2Geometry, torus2Material);
    torus2.rotation.x = Math.PI / 2;
    scene.add(torus2);
    
    camera.position.z = 8;
    
    function animate() {
      requestAnimationFrame(animate);
      
      const time = Date.now() * 0.001;
      
      particles.rotation.x = time * 0.1;
      particles.rotation.y = time * 0.2;
      
      torus.rotation.x = time * 0.5;
      torus.rotation.y = time * 0.3;
      torus.rotation.z = time * 0.2;
      
      torus2.rotation.x = time * 0.3;
      torus2.rotation.y = time * 0.4;
      torus2.rotation.z = time * 0.1;
      
      const scale = 1 + Math.sin(time * 2) * 0.1;
      torus.scale.set(scale, scale, scale);
      torus2.scale.set(1/scale, 1/scale, 1/scale);
      
      renderer.render(scene, camera);
    }
    
    animate();
    
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
    
  } catch (error) {
    console.log('Animation 3D non support√©e:', error);
    document.getElementById('splash').style.background = 'linear-gradient(45deg, #000428, #004e92, #000428)';
    document.getElementById('splash').style.backgroundSize = '400% 400%';
    document.getElementById('splash').style.animation = 'gradientShift 6s ease infinite';
  }
}

// ==================== VARIABLES ====================
let items = [];
let currency = "‚Ç¨";
let signatureData = null;
let currentPDFBlob = null;
let currentPDFUrl = null;

// ==================== INITIALISATION ====================
document.addEventListener('DOMContentLoaded', function() {
  initThreeJS();
  
  setTimeout(() => {
    document.getElementById('splash').classList.add('fade-out');
    setTimeout(() => {
      document.getElementById('splash').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
    }, 1000);
  }, 9000);
  
  const today = new Date().toISOString().split('T')[0];
  document.getElementById("dateEmis").value = today;
  
  const dueDate = new Date();
  dueDate.setDate(dueDate.getDate() + 30);
  document.getElementById("dateDue").value = dueDate.toISOString().split('T')[0];
  
  document.getElementById("invoiceNumber").value = "MT-" + new Date().getFullYear() + "-001";
  
  initSignature();
  
  items.push({desc:"Service de d√©veloppement", qty:1, price:100});
  renderItems();
  updatePreview();
});

// ==================== SIGNATURE ====================
function initSignature() {
  const canvas = document.getElementById("signaturePad");
  const ctx = canvas.getContext("2d");
  
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = "#000000";
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
  ctx.lineJoin = "round";
  
  let drawing = false;
  let lastX = 0;
  let lastY = 0;

  function startDraw(e) {
    drawing = true;
    const pos = getMousePos(canvas, e);
    [lastX, lastY] = [pos.x, pos.y];
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
  }

  function draw(e) {
    if (!drawing) return;
    const pos = getMousePos(canvas, e);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    [lastX, lastY] = [pos.x, pos.y];
  }

  function stopDraw() {
    drawing = false;
  }

  function getMousePos(canvas, evt) {
    const rect = canvas.getBoundingClientRect();
    return {
      x: (evt.clientX - rect.left) * (canvas.width / rect.width),
      y: (evt.clientY - rect.top) * (canvas.height / rect.height)
    };
  }

  canvas.addEventListener("mousedown", startDraw);
  canvas.addEventListener("mousemove", draw);
  canvas.addEventListener("mouseup", stopDraw);
  canvas.addEventListener("mouseout", stopDraw);

  canvas.addEventListener("touchstart", (e) => {
    e.preventDefault();
    startDraw(e.touches[0]);
  });
  
  canvas.addEventListener("touchmove", (e) => {
    e.preventDefault();
    draw(e.touches[0]);
  });
  
  canvas.addEventListener("touchend", stopDraw);
}

document.getElementById("clearSign").addEventListener("click", () => {
  const canvas = document.getElementById("signaturePad");
  const ctx = canvas.getContext("2d");
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  signatureData = null;
  document.getElementById("p_signature").src = "";
  document.getElementById("p_signature").style.display = "none";
});

document.getElementById("saveSign").addEventListener("click", () => {
  const canvas = document.getElementById("signaturePad");
  signatureData = canvas.toDataURL();
  document.getElementById("p_signature").src = signatureData;
  document.getElementById("p_signature").style.display = "block";
});

// ==================== LOGO ====================
const logoInput = document.getElementById("logoUpload");
const logoPreview = document.getElementById("logoPreview");
let logoBase64 = "";

logoInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if(file){
        const reader = new FileReader();
        reader.onload = () => {
            logoBase64 = reader.result;
            logoPreview.src = logoBase64;
            logoPreview.style.display = "block";
            document.getElementById("p_logo").src = logoBase64;
            document.getElementById("p_logo").style.display = "block";
        };
        reader.readAsDataURL(file);
    }
});

// ==================== ARTICLES ====================
document.getElementById("addItem").addEventListener("click", () => {
    items.push({desc:"Nouvel article", qty:1, price:0});
    renderItems();
});

function renderItems(){
    const tbody = document.getElementById("itemsBody");
    tbody.innerHTML = "";
    
    items.forEach((item, i) => {
        const tr = document.createElement("tr");
        const total = (item.qty * item.price).toFixed(2);
        tr.innerHTML = `
        <td><input class="form-control item-desc" data-index="${i}" value="${item.desc}" placeholder="Description"></td>
        <td><input type="number" min="1" step="1" class="form-control item-qty" data-index="${i}" value="${item.qty}"></td>
        <td><input type="number" min="0" step="0.01" class="form-control item-price" data-index="${i}" value="${item.price}"></td>
        <td><strong class="item-total">${currency}${total}</strong></td>
        <td><button type="button" class="btn btn-sm btn-danger remove-item" data-index="${i}">X</button></td>
        `;
        tbody.appendChild(tr);
    });
    
    attachItemEvents();
    updatePreview();
}

function attachItemEvents() {
    document.querySelectorAll('.item-desc').forEach(input => {
        input.addEventListener('input', (e) => {
            const index = parseInt(e.target.getAttribute('data-index'));
            items[index].desc = e.target.value;
        });
    });
    
    document.querySelectorAll('.item-qty').forEach(input => {
        input.addEventListener('input', (e) => {
            const index = parseInt(e.target.getAttribute('data-index'));
            items[index].qty = parseFloat(e.target.value) || 1;
            updateItemTotal(index);
            updatePreview();
        });
    });
    
    document.querySelectorAll('.item-price').forEach(input => {
        input.addEventListener('input', (e) => {
            const index = parseInt(e.target.getAttribute('data-index'));
            items[index].price = parseFloat(e.target.value) || 0;
            updateItemTotal(index);
            updatePreview();
        });
    });
    
    document.querySelectorAll('.remove-item').forEach(button => {
        button.addEventListener('click', (e) => {
            const index = parseInt(e.target.getAttribute('data-index'));
            items.splice(index, 1);
            renderItems();
        });
    });
}

function updateItemTotal(index) {
    const total = (items[index].qty * items[index].price).toFixed(2);
    const totalElements = document.querySelectorAll('.item-total');
    if (totalElements[index]) {
        totalElements[index].textContent = currency + total;
    }
}

// ==================== MISE √Ä JOUR PREVIEW ====================
function updatePreview(){
    document.getElementById("p_entName").innerText = document.getElementById("entName").value || "Nom de l'entreprise";
    document.getElementById("p_entAddress").innerText = document.getElementById("entAddress").value || "Adresse de l'entreprise";
    document.getElementById("p_entSiret").innerText = document.getElementById("entSiret").value ? "SIRET : " + document.getElementById("entSiret").value : "SIRET : ";
    document.getElementById("p_entTVA").innerText = document.getElementById("entTVA").value ? "TVA : " + document.getElementById("entTVA").value : "TVA : ";
    document.getElementById("p_entContact").innerText = document.getElementById("entContact").value || "Contact";

    document.getElementById("p_clientName").innerText = document.getElementById("clientName").value || "Nom du client";
    document.getElementById("p_clientAddress").innerText = document.getElementById("clientAddress").value || "Adresse du client";
    document.getElementById("p_clientEmail").innerText = document.getElementById("clientEmail").value ? "Email : " + document.getElementById("clientEmail").value : "Email : ";
    document.getElementById("p_clientPhone").innerText = document.getElementById("clientPhone").value ? "T√©l√©phone : " + document.getElementById("clientPhone").value : "T√©l√©phone : ";

    document.getElementById("p_invoiceNumber").innerText = document.getElementById("invoiceNumber").value || "N¬∞";
    document.getElementById("p_dateEmis").innerText = document.getElementById("dateEmis").value || "-";
    document.getElementById("p_dateDue").innerText = document.getElementById("dateDue").value || "-";
    document.getElementById("p_notes").innerText = document.getElementById("notes").value || "Aucune note";

    let sousTotal = 0;
    items.forEach(item => {
        sousTotal += item.qty * item.price;
    });
    
    const tvaRate = parseFloat(document.getElementById("tvaValue").value) || 0;
    const TVA = sousTotal * (tvaRate / 100);
    const totalTTC = sousTotal + TVA;

    document.getElementById("p_sousTotal").textContent = currency + sousTotal.toFixed(2);
    document.getElementById("p_TVA").textContent = currency + TVA.toFixed(2);
    document.getElementById("p_totalTTC").textContent = currency + totalTTC.toFixed(2);
}

// ==================== G√âN√âRATION PDF CORRIG√âE ====================
async function generatePDF() {
    if (!signatureData) {
        const canvas = document.getElementById("signaturePad");
        signatureData = canvas.toDataURL();
        if (signatureData) {
            document.getElementById("p_signature").src = signatureData;
            document.getElementById("p_signature").style.display = "block";
        }
    }
    
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p", "mm", "a4");
    const preview = document.getElementById("invoicePreview");
    
    // Sauvegarder le style original
    const originalWidth = preview.style.width;
    const originalMargin = preview.style.margin;
    
    // Optimiser pour le PDF
    preview.style.width = "210mm";
    preview.style.margin = "0";
    
    try {
        const canvas = await html2canvas(preview, {
            scale: 2,
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff',
            width: preview.scrollWidth,
            height: preview.scrollHeight,
            scrollX: 0,
            scrollY: 0,
            windowWidth: preview.scrollWidth,
            windowHeight: preview.scrollHeight,
            onclone: function(clonedDoc) {
                const clonedPreview = clonedDoc.getElementById('invoicePreview');
                if (clonedPreview) {
                    clonedPreview.style.width = "210mm";
                    clonedPreview.style.margin = "0";
                    clonedPreview.style.boxShadow = "none";
                    
                    // Masquer les √©l√©ments d'√©dition dans le PDF
                    const inputs = clonedPreview.querySelectorAll('input');
                    inputs.forEach(input => {
                        const span = document.createElement('span');
                        span.textContent = input.value || input.placeholder;
                        span.style.display = 'inline-block';
                        span.style.width = '100%';
                        span.style.padding = '0.375rem 0.75rem';
                        input.parentNode.replaceChild(span, input);
                    });
                    
                    const buttons = clonedPreview.querySelectorAll('button');
                    buttons.forEach(button => {
                        button.style.display = 'none';
                    });
                    
                    const removeButtons = clonedPreview.querySelectorAll('.remove-item');
                    removeButtons.forEach(button => {
                        button.style.display = 'none';
                    });
                }
            }
        });
        
        const imgData = canvas.toDataURL("image/png");
        const imgWidth = 190; // Largeur maximale dans le PDF
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        // Calculer le nombre de pages n√©cessaires
        const pageHeight = 280; // Hauteur utile par page
        let heightLeft = imgHeight;
        let position = 10; // Position verticale de d√©part
        
        // Premi√®re page
        pdf.addImage(imgData, "PNG", 10, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        // Pages suppl√©mentaires si n√©cessaire
        while (heightLeft > 0) {
            position = -heightLeft + 10; // Ajuster la position
            pdf.addPage();
            pdf.addImage(imgData, "PNG", 10, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }
        
        // Restaurer le style original
        preview.style.width = originalWidth;
        preview.style.margin = originalMargin;
        
        return pdf.output('blob');
        
    } catch (error) {
        console.error("Erreur:", error);
        // Restaurer le style original en cas d'erreur
        preview.style.width = originalWidth;
        preview.style.margin = originalMargin;
        alert("Erreur lors de la g√©n√©ration du PDF");
        return null;
    }
}

// ==================== FONCTIONS DE PARTAGE CORRIG√âES ====================
async function shareOnWhatsApp() {
    try {
        const blob = await generatePDF();
        if (!blob) return;

        // Cr√©er un URL pour le PDF
        const pdfUrl = URL.createObjectURL(blob);
        
        // Message pour WhatsApp
        const message = `Bonjour, voici votre facture ${document.getElementById("invoiceNumber").value || ''} de ${document.getElementById("entName").value || 'MANDO TECH'}. Montant total : ${document.getElementById("p_totalTTC").textContent}`;
        
        // URL WhatsApp correcte avec le num√©ro de t√©l√©phone (remplacez par le num√©ro souhait√©)
        const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
        
        // Ouvrir WhatsApp dans un nouvel onglet
        window.open(whatsappUrl, '_blank');
        
        // T√©l√©charger automatiquement le PDF
        setTimeout(() => {
            const a = document.createElement('a');
            a.href = pdfUrl;
            a.download = `facture-${document.getElementById("invoiceNumber").value || 'mandotech'}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // Nettoyer apr√®s t√©l√©chargement
            setTimeout(() => URL.revokeObjectURL(pdfUrl), 1000);
        }, 1000);
        
    } catch (error) {
        console.error('Erreur partage WhatsApp:', error);
        alert('Le partage a √©chou√©. Le PDF a √©t√© t√©l√©charg√©, vous pouvez le partager manuellement.');
    }
}

function shareByEmail() {
    const subject = `Facture ${document.getElementById("invoiceNumber").value || ''}`;
    const body = `Bonjour,\n\nVeuillez trouver ci-joint la facture ${document.getElementById("invoiceNumber").value || ''}.\n\nMontant total : ${document.getElementById("p_totalTTC").textContent}\n\nCordialement,\n${document.getElementById("entName").value || 'MANDO TECH'}`;
    
    window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

function downloadPDF() {
    if (currentPDFBlob) {
        const url = URL.createObjectURL(currentPDFBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `facture-${document.getElementById("invoiceNumber").value || 'mandotech'}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } else {
        // G√©n√©rer le PDF si pas encore cr√©√©
        document.getElementById("btnPDF").click();
    }
}

function printPDF() {
    if (currentPDFUrl) {
        const printWindow = window.open(currentPDFUrl);
        printWindow.onload = function() {
            printWindow.print();
        };
    } else {
        // G√©n√©rer le PDF si pas encore cr√©√©
        document.getElementById("btnPDF").click();
        setTimeout(() => {
            if (currentPDFUrl) {
                const printWindow = window.open(currentPDFUrl);
                printWindow.onload = function() {
                    printWindow.print();
                };
            }
        }, 2000);
    }
}

// ==================== GESTION DE L'AFFICHAGE PDF ====================
function openSharePage() {
    document.getElementById('pdfSharePage').style.display = 'block';
    document.getElementById('pdfActions').style.display = 'none';
}

function closeSharePage() {
    document.getElementById('pdfSharePage').style.display = 'none';
    document.getElementById('pdfActions').style.display = 'flex';
}

function closePDFView() {
    const pdfModal = bootstrap.Modal.getInstance(document.getElementById('pdfModal'));
    if (pdfModal) {
        pdfModal.hide();
    }
    document.getElementById('pdfActions').style.display = 'none';
    
    if (currentPDFUrl) {
        URL.revokeObjectURL(currentPDFUrl);
        currentPDFUrl = null;
    }
}

// ==================== √âV√âNEMENTS DES BOUTONS DE PARTAGE ====================
document.getElementById("btnPDF").addEventListener("click", async () => {
    const btn = document.getElementById("btnPDF");
    const originalText = btn.innerHTML;
    btn.innerHTML = "‚è≥ G√©n√©ration...";
    btn.disabled = true;
    
    const blob = await generatePDF();
    if (blob) {
        currentPDFBlob = blob;
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `facture-${document.getElementById("invoiceNumber").value || 'mandotech'}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    btn.innerHTML = originalText;
    btn.disabled = false;
});

document.getElementById("btnPreviewPDF").addEventListener("click", async () => {
    const btn = document.getElementById("btnPreviewPDF");
    const originalText = btn.innerHTML;
    btn.innerHTML = "‚è≥ G√©n√©ration...";
    btn.disabled = true;
    
    const blob = await generatePDF();
    if (blob) {
        currentPDFBlob = blob;
        currentPDFUrl = URL.createObjectURL(blob);
        
        // Am√©lioration de l'affichage du PDF
        document.getElementById("pdfPreviewContainer").innerHTML = `
            <iframe class="pdf-iframe" src="${currentPDFUrl}"></iframe>
        `;
        
        const pdfModal = new bootstrap.Modal(document.getElementById('pdfModal'));
        pdfModal.show();
        
        // Afficher les boutons d'action
        document.getElementById('pdfActions').style.display = 'flex';
        
        // Nettoyer l'URL apr√®s fermeture du modal
        document.getElementById('pdfModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('pdfActions').style.display = 'none';
            if (currentPDFUrl) {
                URL.revokeObjectURL(currentPDFUrl);
                currentPDFUrl = null;
            }
        });
    }
    
    btn.innerHTML = originalText;
    btn.disabled = false;
});

// √âv√©nements pour les boutons de partage
document.getElementById("btnOpenSharePage").addEventListener("click", openSharePage);

document.getElementById("btnWhatsAppDirect").addEventListener("click", async () => {
    const btn = document.getElementById("btnWhatsAppDirect");
    const originalText = btn.innerHTML;
    btn.innerHTML = "‚è≥ Pr√©paration...";
    btn.disabled = true;
    
    await shareOnWhatsApp();
    
    btn.innerHTML = originalText;
    btn.disabled = false;
});

document.getElementById("shareWhatsAppFromPreview").addEventListener("click", async () => {
    await shareOnWhatsApp();
});

// Boutons flottants
document.getElementById("btnWhatsAppFloating").addEventListener("click", async () => {
    await shareOnWhatsApp();
});

document.getElementById("btnShareFloating").addEventListener("click", openSharePage);

document.getElementById("btnBackFloating").addEventListener("click", closePDFView);

// Boutons de la page de partage
document.getElementById("shareWhatsAppCard").addEventListener("click", async () => {
    await shareOnWhatsApp();
});

document.getElementById("shareEmailCard").addEventListener("click", shareByEmail);

document.getElementById("downloadPDFCard").addEventListener("click", downloadPDF);

document.getElementById("printPDFCard").addEventListener("click", printPDF);

document.getElementById("btnBackToInvoice").addEventListener("click", closeSharePage);

// ==================== NOUVELLE FACTURE ====================
document.getElementById("btnNew").addEventListener("click", () => {
    if(confirm("Cr√©er une nouvelle facture ? Les donn√©es actuelles seront perdues.")) {
        document.getElementById("entName").value = "";
        document.getElementById("entAddress").value = "";
        document.getElementById("entSiret").value = "";
        document.getElementById("entTVA").value = "";
        document.getElementById("entContact").value = "";
        document.getElementById("clientName").value = "";
        document.getElementById("clientAddress").value = "";
        document.getElementById("clientEmail").value = "";
        document.getElementById("clientPhone").value = "";
        document.getElementById("invoiceNumber").value = "MT-" + new Date().getFullYear() + "-001";
        document.getElementById("notes").value = "";
        document.getElementById("tvaValue").value = "20";
        
        items = [{desc:"Service de d√©veloppement", qty:1, price:100}];
        
        const canvas = document.getElementById("signaturePad");
        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        signatureData = null;
        document.getElementById("p_signature").src = "";
        document.getElementById("p_signature").style.display = "none";
        
        logoBase64 = "";
        document.getElementById("logoPreview").src = "";
        document.getElementById("logoPreview").style.display = "none";
        document.getElementById("p_logo").src = "";
        document.getElementById("p_logo").style.display = "none";
        document.getElementById("logoUpload").value = "";
        
        renderItems();
        updatePreview();
    }
});

// ==================== √âV√âNEMENTS AUTOMATIQUES ====================
document.getElementById("currency").addEventListener("change", e => {
    currency = e.target.value;
    renderItems();
});

const inputsToWatch = [
    "entName", "entAddress", "entSiret", "entTVA", "entContact", 
    "clientName", "clientAddress", "clientEmail", "clientPhone",
    "invoiceNumber", "dateEmis", "dateDue", "tvaValue", "notes"
];

inputsToWatch.forEach(id => {
    document.getElementById(id).addEventListener("input", updatePreview);
});
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
